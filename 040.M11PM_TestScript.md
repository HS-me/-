##vCenter 연결
Connect-VIServer -Server e1-yhs-vcsa01.alt.coin -User administrator@vsphere.local -Password VMware1!


##클러스터 이름 지정.*클러스터 이름* 안은 지정해야함.
$Cluster = Get-Cluster -name "Cluster" | Sort-Object "name"
 
foreach ($ClusterOne in $Cluster) {
 
  ##클러스터에서 호스트들 추출.
  $hosts = Get-Cluster -Name $ClusterOne | Get-VMHost | Sort-Object "name"

    
  ##작업 시작 check
  $StartOperation = (Get-Date)
           
  ## 클러스터 전체 호스트 업그레이드
  foreach ($hostOne in $hosts) {   
            
            
    ##유지보수 모드일때 ESXi Upgrade 
    if ($hostOne.ConnectionState -eq "Maintenance") {   
      Write-Host "작업중인 Host:" $hostOne.Name -ForegroundColor Green        
      Write-Host "Host Version :" $hostOne.Version   -ForegroundColor Green                      
              
                    
        
      ##1.host Update             
      $esxcli = $hostOne  | get-esxcli -v2
      $dszn = "YHSNFS"
      $argsinstall = $esxcli.software.profile.update.createargs()
      $argsinstall.depot = "/vmfs/volumes/$dszn/iso/VMware-ESXi-7.0U3g-20328353-depot.zip"
      $argsinstall.profile = "ESXi-7.0U3g-20328353-standard"
      $argsinstall.nohardwarewarning = $true
      $esxcli.software.profile.update.invoke($argsinstall)
      Write-Host "host Update 완료" -ForegroundColor green

      ##2.driver update
      #$esxcli2 = $hostOne | get-esxcli -v2
      #$argsinstall2 = $esxcli2.software.vib.update.createargs()
      #$argsinstall2.depot = "/vmfs/volume/$dszn/iso/Broadcom-bnxt-Net-RoCE_226.0.221.0-1OEM.700.1.0.15843807_21842159.zip"
      #$esxcli2.software.vib.update.invoke($argsinstall2)      


      ##3. 현재 설치된 OpenManger delete
      $esxcli4 = $hostOne | get-esxcli -v2
      $argsinstall4 = $esxcli4.software.vib.remove.createargs()
      $vibs = $esxcli.software.vib.list.invoke() | Where-Object { $_.Name -match "OpenManage" -or $_.Name -match "openmanage" }


      foreach ($vib in $vibs) {
        $argsinstall4.vibname = $vib.Name
        $esxcli.software.vib.remove.invoke($argsinstall4)
      }

     Write-Host "OpenMange 삭제 완료" -ForegroundColor green

      ##OpenMange 최신 version vib install
      $esxcli5 = $hostOne | get-esxcli -v2
      $argsinstall5 = $esxcli5.software.vib.install.createargs()
      $argsinstall5.depot = "/vmfs/volumes/$dszn/iso/OM-SrvAdmin-Dell-Web-11.0.0.0.5268.VIB-ESXi_A00.zip"
      $esxcli5.software.vib.install.invoke($argsinstall5)

      Write-Host "OpenMange 설치 완료" -ForegroundColor green
 
    }        
    else {
        ##유지보수가 아닐시 유지보수모드 필요 항목
         Write-Host "$hostOne 작업 필요 시 유지보수 모드 실행 필요합니다."  -ForegroundColor yellow -BackgroundColor Red           
    }   
    #작업 끝 Check
    $EndOperation = (Get-Date) 
    ##총 작업시간.
    $duration = [math]::Round((New-TimeSpan -Start $StartOperation -End $EndOperation).TotalMinutes, 4)
  } 
  Write-Host "총 작업시간:" $duration"분" -ForegroundColor green
}
         