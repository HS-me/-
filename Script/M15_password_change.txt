##vCenter 연결
$vCenter = "ckh-vcsa-01.alt.coin"
Write-Host "vCenter 접속 $vCenter" -ForegroundColor Green   
$User = "administrator@vsphere.local"
$Password = "VMware1!"
Connect-VIServer -Server $vCenter -User $User -Password $Password

##클러스터 이름 지정.*클러스터 이름* 안은 지정해야함.
$Cluster = Get-Cluster -name "vSANCluster" | Sort-Object "name"
 
#패스워드 바꿀건지 확인 받기
$confirmation = Read-host -Prompt  "정말로 호스트 패스워드를 바꾸시겠습니까?[y/n] *소문자로만 입력해주세요"
if ($confirmation -eq 'y') {
  Write-host "기본적으로 암호를 생성할 때는 소문자, 대문자, 숫자, 특수 문자 중 세 가지 이상을 혼합하여 포함해야 합니다.(최소 7자 이상 최대 40자 미만)"  -ForegroundColor yellow 
  $SecurehostPassword = Read-host  "변경 할 Password를 적어주세요" 
  $hostPassword = $SecurehostPassword 
  $SecureCheckhostPassword = Read-host  "변경 할 Password를 다시적어주세요"  
  $reCheckhostPassword = $SecureCheckhostPassword

  if ( $hostPassword -eq $reCheckhostPassword  ) {
    $chagePassword = $hostPassword
    foreach ($clusterOne in $Cluster) {
        
      ##클러스터에서 호스트들 추출.
      $hosts = Get-Cluster -Name $clusterOne | Get-VMHost | Sort-Object "name"
        
        
      ##작업 시작 check
      $StartOperation = (Get-Date)
        
      ## 클러스터 전체 호스트 반복문 실행
      foreach ($hostOne in $hosts) {   
            
        $esxcli = Get-EsxCli -VMHost $hostOne -v2  
            
        Write-Host "작업중인 Host: $hostOne" -ForegroundColor Green   
            
        ## host Pw 변경
        $arg = $esxcli.system.account.set.CreateArgs()
        $arg.id = ‘root’
            
        ## NewPassword에 새로운 비밀번호 변경할 Pw 넣기.
        $arg.password = $chagePassword
        $arg.passwordconfirmation = $arg.password
            
        #Set new password 저장하기
        $esxcli.system.account.set.Invoke($arg) 
            
            
        #작업 끝 Check
        $EndOperation = (Get-Date) 
        ##총 작업시간.
        $duration = [math]::Round((New-TimeSpan -Start $StartOperation -End $EndOperation).TotalMinutes, 4)
      } 
      ##PassWord 변경 작업 완료. 
      Write-Host "총 작업시간:" $duration"분" -ForegroundColor yellow
      Write-Host "Host PassWord 변경 작업 완료" -ForegroundColor yellow  -BackgroundColor red 
    }
  }
  else {
    Write-Host "패스워드를 재확인 해주세요" -ForegroundColor yellow  -BackgroundColor red 
  }
}
else {
  Write-Host "패스워드 변경 작업을 중지합니다. " -ForegroundColor yellow  -BackgroundColor red 
}

    