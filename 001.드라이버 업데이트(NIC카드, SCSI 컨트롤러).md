# 사전 점검 사항
0. 업데이트 이유
  - 버전 맞추기
  - 버그 해결
  - PSOD 이슈
  - ping loss 이슈

1. 호환성 체크 (하드웨어측과 협의)
  - VMware 호환성 가이드
https://www.vmware.com/resources/compatibility/search.php
  - 하드웨어 (VMware 호환성 가이드에 없다면 아래와 같은 하드웨어 벤더 링크 참조)
https://support.lenovo.com/us/en/solutions/ht505359-os-support-center-vmware
** 호환성 검증은 하위 LEVEL 벤더에서 검증한다 

2. VM 영향도 체크 및 협의
  - 타겟 NIC에 해당하는 
  - 어떻게 마이그레이션 할지

3. 타겟 드라이버를 데이터 스토어에 업로드
  - 드라이버 파일 확인
  - 타겟 호스트에서 데이터 스토어 접근 여부 확인
  - 업로드 경로 확인


# 작업 프로시저
0. 업그레이드 대상 확인 및 유지보수 진입
  - FQDN, IP, FW ver., Driver ver., 유지보수 모드 상태 (메모장에 미리 정리)
- 해당 스토리지 확인 LUN , 경로
- esxcli vm process list로 혹시 유지보수모드 진입했으나 실행중인 vm이 있는지 확인인

1. 현재 드라이버 체크 하기
  - esxcli software vib list | grep i40en (모든 드라이버 확인 가능)
  - esxcli network nic get -n vmnic0  (해당 vmnic의 펌웨어&드라이버 확인 가능)
** GUI에서는 펌웨어를 확인 할 수 없으므로 CLI에서 확인해야함


2. (HW작업) FW업데이트 
  - VM 마이그레이션 해주고 HOST power off 해준다

3. FW 업데이트 확인
  - esxcli network nic get -n vmnic0  (해당 vmnic의 펌웨어&드라이버 확인 가능)
  - 타겟 호스트가 올바르게 종료되었는지도 확인

4. NIC들이 정상상태인지 확인
  - esxcli network nic list (정상 상태가 아니라면 HW 엔ㅁ지니어에게 문의)
  - up이랑 down 확인

5. 0.에서 정리된 메모장을 보고 PUTTY 접속 확인
6. Driver 업데이트 진행
  - esxcli software vib update -d /vmfs/경로/~.zip --dry-run 으로 확인 후
  - esxcli software vib update -d /vmfs/경로/~.zip
** 이때 dryrun 인지, reboot 필요여부 확인
** -d : zip 파일 // -n : vib 파일 // -v : vib url 경로

7. reboot 
8. 작업 후 체크리스트
  - reboot 체크리스트
  - esxcli network nic list
  - esxcli network nic get -n vmnic0
  - log 확인 (esxupdate.log,//vmkernel.log(전체 로그),vobd.log(nic 상태))
  - #ntpq -p (ntp 확인/ GUI에서 )

# 작업 시 발생  할 수 있는 이슈 및 특이사항
2023.05.15
**system-resolved Memorry 과다 점유(메모리 누수)로 인한 VC 종료(vpxd down)**
VC에서 top 명령어로 메모리 free (GB단위)량과
stats로 데몬의 상태 확인 (vpxd가 stopped에 들어가 있음)
용훈과장이 SR을 통해 받은 workaround로 이슈 해결

2023.05.23
드라이버 업데이트 명령어 복사 붙여넣기 하다가 명령어 2번 연속으로 들어감
->> 업데이트 후 버전이 높아졌음에도 skipped 되었음
운좋게 올라가긴함 침착하게 입력하자..

# 작업 시 주의 사항
2023.05.16
esxcli software vib update -d /vmfs/경로/~.zip --dry-run 으로 확인 후 skipped가 나오면
보통 높은버전에서 낮은버전으로 바꿀때 발생하는 이슈 ->> install , --dry-run check

